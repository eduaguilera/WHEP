<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Bilateral trade data — get_bilateral_trade • WHEP</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Bilateral trade data — get_bilateral_trade"><meta name="description" content="Clean CSV data from the given file_path. Fill missing data and balance
trade totals."><meta property="og:description" content="Clean CSV data from the given file_path. Fill missing data and balance
trade totals."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">WHEP</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/trade-sources-coverage.html">Trade sources year coverage</a></li>
    <li><a class="dropdown-item" href="../articles/workflow-intro.html">Follow the workflow</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Bilateral trade data</h1>

      <div class="d-none name"><code>get_bilateral_trade.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Clean CSV data from the given <code>file_path</code>. Fill missing data and balance
trade totals.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">get_bilateral_trade</span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-file-path">file_path<a class="anchor" aria-label="anchor" href="#arg-file-path"></a></dt>
<dd><p>The local path where the input CSV is located. It is
recommended to use an autogenerated path by <code><a href="get_file_path.html">get_file_path()</a></code> function.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A tibble with the reported trade between countries. For efficient
memory usage, the tibble is not exactly in tidy format.
It contains the following columns:</p><ul><li><p><code>year</code>: The year in which the recorded event occurred.</p></li>
<li><p><code>item</code>: Natural language name for the item that is being traded.</p></li>
<li><p><code>bilateral_trade</code>: Square matrix of <code>NxN</code> dimensions where <code>N</code> is the
total number of countries being considered. The matrix row and column
names are exactly equal and they represent country codes.</p><ul><li><p>Row name: FAOSTAT internal code for the country that is exporting the
item. Equivalences with ISO 3166-1 numeric can be found in the
<em>Area Codes</em> CSV from the zip file that can be downloaded from
<a href="https://www.fao.org/faostat/en/#data/FBS" class="external-link">FAOSTAT</a>. TODO: Think about
this, would be nice to use ISO3 codes but won't be enough for our
periods</p></li>
<li><p>Column name: FAOSTAT internal code for the country that is importing the
item. See row name explanation above.</p></li>
</ul><p>If <code>m</code> is the matrix, the value at <code>m["A", "B"]</code> is the trade in tonnes
from country <code>"A"</code> to country <code>"B"</code>, for the corresponding year and item.
The matrix can be considered <em>balanced</em>. This means:</p><ul><li><p>The sum of all values from row <code>"A"</code>, where <code>"A"</code> is any country,
should match the total exports from country <code>"A"</code> reported in the
commodity balance sheet (which is considered more accurate for totals).</p></li>
<li><p>The sum of all values from column <code>"A"</code>, where <code>"A"</code> is any country,
should match the total imports into country <code>"A"</code> reported in the
commodity balance sheet (which is considered more accurate for totals).</p></li>
</ul><p>The sums may not be exactly the expected values because of precision
issues and/or the iterative proportional fitting algorithm not converging
fast enough, but should be relatively very close to the desired totals.</p></li>
</ul><p>The step by step approach to obtain this data tries to follow the FABIO
model and is explained below. All the steps are performed separately for
each group of year and item.</p><ul><li><p>From the FAOSTAT reported bilateral trade, there are sometimes two values
for one trade flow: the exported amount claimed by the reporter country
and the import amount claimed by the partner country. Here, the export
data was preferred, i.e., if country <code>"A"</code> says it exported <code>X</code> tonnes to
country <code>"B"</code> but country <code>"B"</code> claims they got <code>Y</code> tonnes from country
<code>"A"</code>, we trust the export data <code>X</code>. This choice is only needed if there
exists a reported amount from both sides. Otherwise, the single existing
report is chosen.</p></li>
<li><p>Complete the country data, that is, add any missing combinations of
country trade with NAs, which will be estimated later. In the matrix
form, this doesn't increase the memory usage since we had to build a
matrix anyway (for the balancing algorithm), and the <em>empty</em> parts also
take up memory. This is also done for total imports/exports from the
commodity balance sheet, but these are directly filled with 0s instead.</p></li>
<li><p>The total imports and exports from the commodity balance sheet are
balanced by downscaling the largest of the two to match the lowest.
This is done in the following way:</p><ul><li><p>If <code>total_imports &gt; total_exports</code>: Set <code>import</code> as
<code>total_exports * import / total_import</code>.</p></li>
<li><p>If <code>total_exports &gt; total_exports</code>: Set <code>export</code> as
<code>total_exports * export / total_export</code>.</p></li>
</ul></li>
<li><p>The missing data in the matrix must be estimated. It's done like this:</p><ul><li><p>For each pair of exporter <code>i</code> and importer <code>j</code>, we estimate a bilateral
trade <code>m[i, j]</code> using the export shares of <code>i</code> and import shares of <code>j</code>
from the commodity balance sheet:</p><ul><li><p><code>est_1 &lt;- exports[i] * imports[j] / sum(imports)</code>, i.e., total
exports of country <code>i</code> spread among other countries' import shares.</p></li>
<li><p><code>est_2 &lt;- imports[j] * exports[i] / sum(exports)</code>, i.e. total
imports of country <code>j</code> spread among other countries' export shares.</p></li>
<li><p><code>est &lt;- (est_1 + est_2) / 2</code>, i.e., the mean of both estimates.</p></li>
</ul><p>In the above computations, exports and imports are the original values
before they were balanced.</p></li>
<li><p>The estimates for data that already existed (i.e. non-NA) are discarded.
For the ones left, for each row (i.e. exporter country), we get the
difference between its balanced total export and the sum of original
non-estimated data. The result is the <em><code>gap</code></em> we can actually fill with
estimates, so as to not get past the reported total export. If the sum
of non-discarded estimates is larger, it must be downscaled and spread
by computing
<code>gap * non_discarded_estimate / sum(non_discarded_estimates)</code>.</p></li>
<li><p>The estimates are divided by a <em>trust factor</em>, in the sense that we
don't rely on the whole value, thinking that a non-present value might
actually be because that specific trade was 0, so we don't overestimate
too much. The chosen factor is 10%, so only 10% of the estimate's value
is actually used to fill the NA from the original bilateral trade
matrix.</p></li>
</ul></li>
<li><p>The matrix is balanced, as mentioned before, using the
<a href="https://en.wikipedia.org/wiki/Iterative_proportional_fitting" class="external-link">iterative proportional fitting algorithm</a>. The target sums for rows and columns are respectively the balanced
exports and imports computed from the commodity balance sheet. The
algorithm is performed directly using the <a href="https://cran.r-project.org/web/packages/mipfp/index.html" class="external-link">mipfp R package</a>.</p></li>
</ul></div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="fu">get_bilateral_trade</span><span class="op">(</span><span class="fu"><a href="get_file_path.html">get_file_path</a></span><span class="op">(</span><span class="st">"bilateral_trade"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by First Last.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

